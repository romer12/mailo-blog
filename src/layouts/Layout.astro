---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Sidebar from '../components/Sidebar.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Search from '../components/Search.astro';
import { getCollection } from 'astro:content';
import '@fortawesome/fontawesome-free/css/all.min.css';
import 'highlight.js/styles/github-dark.css';

interface Props {
  title?: string;
  description?: string;
  showSidebar?: boolean;
  showToc?: boolean;
  categories?: any[];
  tags?: any[];
  keywords?: string;
  image?: string;
  author?: string;
  type?: string;
}

const { 
  title = '止于秋水 博客',
  description = '记录一些知识，以免忘记',
  showSidebar = true,
  showToc = false,
  categories = [],
  tags = [],
  keywords = '博客,技术,编程,前端,后端',
  image = '/favicon.svg',
  author = '止于秋水',
  type = 'website'
} = Astro.props;

// 如果没有传入 tags，从 Collection 中获取
let finalTags = tags;
if (showSidebar) {
  try {
    // 如果 tags 是空数组，从 Collection 获取
    if (tags.length === 0) {
      const allPosts = await getCollection('blog', ({ data }) => {
        return data.draft !== true;
      });
      
      // 统计每个标签的文章数量
      const tagCount = new Map<string, number>();
      allPosts.forEach(post => {
        post.data.tags?.forEach(tag => {
          tagCount.set(tag, (tagCount.get(tag) || 0) + 1);
        });
      });
      
      // 生成标签列表
      finalTags = Array.from(tagCount.entries()).map(([name, count]) => ({
        name,
        slug: name.toLowerCase().replace(/\s+/g, '-'),
        article_count: count,
        color: null
      }));
    } else {
      // 如果传入的是字符串数组，转换为对象数组
      finalTags = tags.map(tag => {
        if (typeof tag === 'string') {
          return {
            name: tag,
            slug: tag.toLowerCase().replace(/\s+/g, '-'),
            article_count: 0,
            color: null
          };
        }
        return tag;
      });
    }
  } catch (error) {
    console.error('Failed to process tags:', error);
    finalTags = [];
  }  
}

// 安全地构造 URL
const siteUrl = Astro.site?.toString() || 'http://localhost:4321';
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const imageURL = new URL(image, siteUrl);
const fullTitle = title === '止于秋水' ? title : `${title} - 止于秋水`;

---
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0"  />
		<!-- Primary Meta Tags -->
		<title>{fullTitle}</title>
		<meta name="title" content={fullTitle} />
		<meta name="description" content={description} />
		<meta name="keywords" content={keywords} />
		<meta name="author" content={author} />
		<link rel="canonical" href={canonicalURL} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={fullTitle} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={imageURL} />
		<meta property="og:locale" content="zh_CN" />
		<meta property="og:site_name" content="止于秋水" />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={fullTitle} />
		<meta property="twitter:description" content={description} />
		<meta property="twitter:image" content={imageURL} />

		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		
		<!-- RSS Feed -->
		<link rel="alternate" type="application/rss+xml" title="止于秋水 RSS Feed" href="/rss.xml" />
		
		<!-- Preconnect to external domains -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
	</head>
	<body>
		<div id="app">
			<Header />

			<div class="app-content">
				{showSidebar ? (
					<div class="content-with-sidebar">
						<main class="main-content">
							<slot />
						</main>
						<Sidebar categories={categories} tags={finalTags} />
					</div>
				) : showToc ? (
					<div class="content-with-sidebar">
						<main class="main-content">
							<slot />
						</main>
						<TableOfContents />
					</div>
				) : (
					<main class="main-content-full">
						<slot />
					</main>
				)}
			</div>

			<Footer />

			<!-- 搜索弹层 -->
			<Search />

			<!-- 浮动按钮组 -->
			<div class="float-buttons">
				<!-- 回到顶部按钮 -->
				<button id="backToTop" class="float-btn back-to-top" aria-label="回到顶部" title="回到顶部">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
					<polyline points="18 15 12 9 6 15"></polyline>
					</svg>
				</button>
			</div>

		</div>
	</body>
</html>

<script>
	// 回到顶部按钮功能
	const backToTopBtn = document.getElementById('backToTop');
	
	// 监听滚动事件
	window.addEventListener('scroll', () => {
		if (window.pageYOffset > 300) {
			backToTopBtn?.classList.add('visible');
		} else {
			backToTopBtn?.classList.remove('visible');
		}
	});
	
	// 点击回到顶部
	backToTopBtn?.addEventListener('click', () => {
		window.scrollTo({
			top: 0,
			behavior: 'smooth'
		});
	});
</script>

<style lang="scss">
	@use '../styles/variables.scss' as *;

	html,
	body {
		margin: 0;
		padding: 0;
		max-width: 100vw;
	}

	#app {
		min-height: 100vh;
		padding-top: 70px;
		width: 100%;
		max-width: 100vw;
		display: flex;
		flex-direction: column;
		background: var(--background);
	}

	.app-content {
		flex: 1;
		width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		box-sizing: border-box;
		padding: 10px;
	}
	
	.content-with-sidebar {
		display: flex;
		gap: 32px;
		align-items: flex-start;
		padding: 32px 0;
		width: 100%;
		box-sizing: border-box;
	}
	
	.main-content {
		flex: 1;
		min-width: 0;
		max-width: 100%;
		overflow-x: hidden;
	}
	
	.main-content-full {
		width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		padding: 32px 0;
		box-sizing: border-box;
	}
	
	@media (max-width: 1024px) {
		.content-with-sidebar {
			flex-direction: column;
		}
		.main-content {
			width: 100%;
		}
	}

	// 浮动按钮组
	.float-buttons {
		position: fixed;
		bottom: 6rem;
		right: 2rem;
		display: flex;
		flex-direction: column;
		gap: $font-xs;
		z-index: 999;
		
		@media (max-width: 768px) {
			bottom: 4rem;
			right: 1.5rem;
			gap: 0.5rem;
		}
	}
	
	.float-btn {
		width: 46px;
		height: 46px;
		background: var(--bg-card);
		color: var(--text-secondary);
		border: 1px solid var(--border-color);
		border-radius: 50%;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		opacity: 0;
		visibility: hidden;
		transform: translateY(20px) scale(0.8);
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		
		&.visible {
			opacity: 1;
			visibility: visible;
			transform: translateY(0) scale(1);
		}
		
		&:hover {
			background: $primary;
			color: white;
			border-color: $primary;
			transform: translateY(-4px) scale(1.05);
			box-shadow: 0 8px 20px rgba($primary, 0.3);
		}
		
		&:active {
			transform: translateY(-2px) scale(1);
		}
		
		svg {
			width: 20px;
			height: 20px;
			transition: transform 0.3s ease;
		}
		
		&:hover svg {
			transform: translateY(-2px);
		}
		
		@media (max-width: 768px) {
			width: 42px;
			height: 42px;
			
			svg {
				width: 18px;
				height: 18px;
			}
		}
	}
	
	.back-to-top {
		&:hover {
			transform: translateY(-4px);
		}
	}
</style>
