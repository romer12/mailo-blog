---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import ArticleRow from '../../components/ArticleRow.astro';

// 为 SSG 生成静态路径
export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });
  
  // 获取所有标签
  const allTags = allPosts.flatMap(post => post.data.tags);
  const uniqueTags = [...new Set(allTags)];
  
  return uniqueTags.map(tag => ({
    params: { slug: tag.toLowerCase().replace(/\s+/g, '-') },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const { slug } = Astro.params;

// 获取所有博客文章
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// 筛选该标签下的文章
const articles = allPosts
  .filter(post => post.data.tags.includes(tag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// 获取所有分类和标签（用于侧边栏）
const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
const allTags = allPosts.flatMap(post => post.data.tags);
const tags = [...new Set(allTags)];
---

<Layout 
  title={`#${tag} - 止于秋水 博客`}
  description={`${tag}标签下的所有文章`}
  showSidebar={true}
  categories={categories}
  tags={tags}
>
  <div class="tag-detail-page">
    <div class="tag-header">
      <div class="tag-info">
        <h1 class="tag-name">
          #{tag}
        </h1>
        <p class="tag-description">{tag} 相关的文章</p>
        <span class="article-count">{articles.length} 篇文章</span>
      </div>
    </div>
    
    {articles.length === 0 ? (
      <div class="empty-state">
        <p>该标签下暂无文章</p>
      </div>
    ) : (
      <div class="articles-list">
        {articles.map((post) => (
          <ArticleRow
            slug={post.slug}
            title={post.data.title}
            description={post.data.description}
            publishDate={post.data.publishDate}
            category={post.data.category}
            tags={post.data.tags}
            heroImage={post.data.heroImage}
          />
        ))}
      </div>
    )}
  </div>
</Layout>

<style lang="scss">
  @use '../../styles/variables.scss' as *;
  
  .tag-detail-page {
    min-height: 400px;
  }
  
  .tag-header {
    margin-bottom: $spacing-2xl;
    background-color: var(--bg-card);
    border-radius: $radius-lg;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }
  
  .tag-info {
    padding: $spacing-xl;
  }
  
  .tag-name {
    font-size: $font-3xl;
    font-weight: 700;
    margin-bottom: $spacing-md;
    color: $primary;
  }
  
  .tag-description {
    color: var(--text-secondary);
    line-height: 1.8;
    margin-bottom: $spacing-md;
  }
  
  .article-count {
    display: inline-block;
    padding: 0.5rem 1rem;
    background-color: rgba($primary, 0.1);
    color: $primary;
    border-radius: $radius-full;
    font-size: $font-sm;
    font-weight: 500;
  }
  
  .articles-list {
    display: grid;
    gap: 24px;
    width: 100%;
  }
  
  .empty-state {
    text-align: center;
    padding: $spacing-2xl;
    color: var(--text-secondary);
    background-color: var(--bg-card);
    border-radius: $radius-lg;
  }
</style>
