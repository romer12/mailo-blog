---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import ArticleRow from '../../components/ArticleRow.astro';

// 为 SSG 生成静态路径
export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });
  
  // 获取所有分类
  const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
  
  return categories.map(category => ({
    params: { slug: category?.toLowerCase().replace(/\s+/g, '-') },
    props: { category }
  }));
}

const { category } = Astro.props;
const { slug } = Astro.params;

// 获取所有博客文章
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// 筛选该分类下的文章
const articles = allPosts
  .filter(post => post.data.category === category)
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// 获取所有分类和标签（用于侧边栏）
const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
const allTags = allPosts.flatMap(post => post.data.tags);
const tags = [...new Set(allTags)];
---

<Layout 
  title={`${category} - 分类 - 止于秋水 博客`}
  description={`${category} 分类下的所有文章`}
  showSidebar={true}
  categories={categories}
  tags={tags}
>
  <div class="category-page">
    <!-- 分类头部 -->
    <div class="category-header">
      <div class="category-info">
        <h1 class="category-title">
          <i class="fas fa-folder"></i>
          {category}
        </h1>
        <p class="category-description">{category} 相关的文章</p>
        <div class="category-meta">
          <span class="meta-item">
            <i class="fas fa-file-alt"></i>
            {articles.length} 篇文章
          </span>
        </div>
      </div>
    </div>

    <!-- 文章列表 -->
    <div class="articles-section">
      {articles.length === 0 ? (
        <div class="empty-state">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <p>该分类下暂无文章</p>
        </div>
      ) : (
        <div class="articles-list">
          {articles.map((post) => (
            <ArticleRow
              slug={post.slug}
              title={post.data.title}
              description={post.data.description}
              publishDate={post.data.publishDate}
              category={post.data.category}
              tags={post.data.tags}
              heroImage={post.data.heroImage}
            />
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>

<style lang="scss">
  @use '../../styles/variables.scss' as *;
  
  .category-page {
    max-width: 100%;
  }
  
  .category-header {
    background: var(--bg-card);
    border-radius: $radius-xl;
    padding: $spacing-2xl;
    margin-bottom: $spacing-2xl;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }
  
  .category-info {
    position: relative;
    z-index: 1;
  }
  
  .category-title {
    font-size: $font-3xl;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: $spacing-md;
    display: flex;
    align-items: center;
    gap: $spacing-md;
    
    i {
      color: $primary;
    }
    
    @media (max-width: 768px) {
      font-size: $font-2xl;
    }
  }
  
  .category-description {
    font-size: $font-lg;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: $spacing-lg;
  }
  
  .category-meta {
    display: flex;
    gap: $spacing-lg;
    flex-wrap: wrap;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: $spacing-xs;
    font-size: $font-sm;
    color: var(--text-secondary);
    padding: $spacing-xs $spacing-md;
    background: var(--hover-bg);
    border-radius: $radius-md;
    
    i {
      color: $primary;
    }
  }
  
  .articles-section {
    min-height: 400px;
  }
  
  .articles-list {
    display: grid;
    gap: 20px;
    width: 100%;
  }
  
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    background: var(--bg-card);
    border-radius: $radius-xl;
    box-shadow: var(--shadow-sm);
    
    svg {
      color: var(--text-tertiary);
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }
    
    p {
      font-size: 1.25rem;
      color: var(--text-secondary);
    }
  }
</style>
